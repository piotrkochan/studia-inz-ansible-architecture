---
- name: "Stopping {{ mysql }}"
  service:
    name: mysqld"
    state: stopped

- name: Generate configuration
  template:
    src:  xtradb.cnf.j2
    dest: "{{ percona__config_file }}"
    owner: root
    group: root
    mode: 0644

- name: Configure swappiness
  sysctl:
    name: vm.swappiness
    value: 0
    state: present

- name: Start the master node
  service:
    name: mysqld@bootstrap.service"
    state: started
  when:
    - percona__bind_address == percona__master_node

- name: Create SST user
  mysql_user:
    login_user: "{{ percona__root_user }}"
    login_password: "{{ percona__root_password }}"
    user: "{{ percona__sst_user }}"
    password: "{{ percona__sst_password }}"
    priv: "*.*:grant,reload,lock tables,process,replication client"
  when:
    - percona__bind_address == percona__master_node

- name: Start the slave nodes
  service:
    name: mysqld"
    state: started
  when:
    - percona__bind_address != percona__master_node

- name: Marking as configured
  file:
    path: "{{ percona__confmark_configured }}"
    state: touch
    owner: root
    group: root
    mode: 0400
