---

# - name: "Create language dir symlink"
#   file:
#     src: "/usr/share/percona-server"
#     dest: "/usr/share/mysql"
#     state: "link"

- name: Configure mysqld
  template:
    src: mysqld.cnf.j2
    dest: /etc/percona-xtradb-cluster.conf.d/mysqld.cnf
  register: mysql_service

- name: Configure wsresp
  template:
    src: wsrep.cnf.j2
    dest: /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
  register: mysql_service

- name: "Ensure that percona is running and enabled"
  service:
    name: "mysql"
    state: "started"
    enabled: "yes"
  register: mysql_service

# This service restart is needed when changing default percona__mysql_datadir, mysql_native_password
# and other settings. So better restart when the my.cnf file changes
# Restart when my.cnf has changed and it has not been restarted by the above task
- name: "Restart mysql to apply changes done in my.cnf file"
  service:
    name: "mysql"
    state: "restarted"
  when:
    - config_file.changed
    - mysql_service is defined
    - not mysql_service.changed
